<?php
class VioPaymentCurl extends SplickitCurl
{

    /*  DUPLICATE {"path":"/payments","route":"/payments","mode":"post","status":"422 Unprocessable Entity","errors":{"payment":{"gateway_error":[{"message":"DUPLICATE TRANS"}]}},"data":{"payment":{"captures":[],"fraudulence":{"_id":"5a009404a9e7c01f06000be3","confidence":-1,"blocked":false,"flagged":false},"gateway_options":{},"refunds":[],"response":{"params":{"order_number":"17259175","recurring":"0","reference":"AB6HBvBJh0","risk":"00","code":"000000","success":"X","avs_result":"","cvv_result":"","front_end":"45","message":"DUPLICATE TRANS"},"cvv_result":{"code":null,"message":null},"avs_result":{"code":null,"message":null,"street_match":null,"postal_match":null},"success?":false,"test":false,"message":"DUPLICATE TRANS","authorization":"AB6HBvBJh0;bankcard"},"_id":"5a009403a9e7c01f06000be2","account_id":"51a8dd097a0bfba2e8000003","amount":"6.12","authorization_id":"AB6HBvBJh0","cents":612,"created_at":"2017-11-06T16:55:32Z","credit_card_brand":"visa","credit_card_id":"593eb21e75f9ebbca200044b","credit_card_identifier":"8726-2079k-mml39-oa4ji","credit_card_last_four":"1914","currency":"USD","cvv_to_destination":false,"destination_id":"5435a03ca9e7c0031a000455","destination_identifier":"C1HY6SSJH6","destination_kind":"sage","destination_name":"sage_gateway_8","destination_request_time":1.645500599,"first_name":"Emmanuel","zip":"32738","void_status":"unvoided","updated_at":"2017-11-06T16:55:36Z","transaction_id":"AB6HBvBJh0","gateway_order_id":"17259175","identifier":"a1d42caa-2ec8-45cf-9054-1cf58c6b9996","kind":"authorize","last_name":"Benitez","status":"failure","transacted":false,"require_cvv":false,"destination":"C1HY6SSJH6","credit_card":"8726-2079k-mml39-oa4ji","links":[{"rel":"self","href":"https://api.value.io/v1/payments/5a009403a9e7c01f06000be2"},{"rel":"index","href":"https://api.value.io/v1/payments"}]}}} */

	var $user_password = "";
	static function curlIt($url,$data,$username_password)
	{
		if ($_SERVER['NO_MOCKS']) {
			return VioPaymentCurl::curlItNoMock($url, $data, $username_password);
		}
        if ($_SERVER['TEST_TIMEOUT'] == 'true') {
            $url = "http://localhost:8888/smaw/phone/testtimeout";
            $response['error'] = 'Timeout';
            $response['error_no'] = 28;
            return $response;
        } else if ($_SERVER['TEST_VIO_TIMEOUT'] == 'true') {
            $json_result = "<html><body><h1>504 Gateway Time-out</h1>The server didn't respond in time.</body></html>";
            $http_code = 504;
        } else if ($_SERVER['TEST_GATEWAYRESET'] == 'true') {
            $json_result = '{ "path":"/payments", "route":"/payments", "mode":"post", "status":"422 Unprocessable Entity", "errors":{"payment":{ "exception":[{ "message":"The remote server reset the connection", "class":"ActiveMerchant::ConnectionError", "backtrace":[]} ]} }, "data":{"payment":{ "captures":[ ], "fraudulence":{"flagged":false,"blocked":false,"confidence":-1,"_id":"5579e4c5a9e7c0cf8b00055e" }, "refunds":[ ], "response":{"exception":"The remote server reset the connection" }, "_id":"5579e4c5a9e7c0cf8b00055d", "account_id":"51a8dd097a0bfba2e8000003", "amount":"8.51", "cents":851, "created_at":"2015-06-11T19:43:01Z", "credit_card_brand":"visa", "credit_card_id":"53bdddef3xxxxxxxxxxx2395", "credit_card_identifier":"5067-7k61n-cokkm-9goq8", "credit_card_last_four":"2945", "currency":"USD", "destination_id":"547e0c73a9e7c092f00001d4", "destination_identifier":"M624K9SSHR", "destination_kind":"mercury", "destination_name":"mercury_gateway_66", "first_name":"Darian", "status":"failure", "void_status":"unvoided", "updated_at":"2015-06-11T19:43:06Z", "transaction_id":null, "gateway_order_id":"7322114", "identifier":"72044ded-39e0-4b11-a502-d2ea731dda3d", "kind":"purchase", "last_name":"Grooms", "require_cvv":false, "transacted":false, "zip":"30041", "destination":"M624K9SSHR", "credit_card":"5067-7k61n-cokkm-9goq8", "links":[{ "rel":"self", "href":"https://api.value.io/v1/payments/5579e4c5a9e7c0cf8b00055d"},{ "rel":"index", "href":"https://api.value.io/v1/payments"} ]} }}';
            $http_code = 422;
        } else if (substr_count($url, "/payments")) {
			$key_values_alpha = '%/payments/([0-9a-zA-Z]+)$%';
			if (preg_match($key_values_alpha, $url, $matches)) {
				myerror_log("we have a void");
				if (getProperty("force_void_fail") == 'true' || $matches[1] == '1234567890') {
					$json_result = '{"path":"/payments","route":"/payments","mode":"put","status":"422 Unprocessable Entity","params":{"payment":{"kind":"void"}}}';
					$http_code = 422;	
				} else {
					$json_result = '{"path":"/payments/'.$matches[1].'","route":"/payments","mode":"put","status":"200 OK","params":{"payment":{"kind":"void"}}}';
					$http_code = 200;
				}
			} else {
				$identifier = $data['payment']['credit_card'];
                if (substr($identifier,-11) == 'ttttt-ttttt') {
                    $response['error'] = 'Timeout';
                    $response['error_no'] = 28;
                    return $response;
                }
                if ($data['payment']['kind'] == 'refund') {
                    if ($identifier == 'ppppp-ppppp-ppppp-ppppp') {
                        // we are forcing a partial fail due to unsettled transaction
                        $json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"422 Unprocessable Entity","errors":{"payment":{"gateway_error":[{"message":"CREDIT VOL EXCEEDED 0.0000"}]}},"data":{"payment":{"captures":[],"refunds":[],"response":{"cvv_result":{"code":"P","message":"Not Processed"},"avs_result":{"message":null,"code":null,"street_match":null,"postal_match":null},"params":{"avs_result":"","order_number":"1xxxxxxxxxxx5362","recurring":"0","reference":"EASE7anMb0","risk":"01","cvv_result":"P","message":"CREDIT VOL EXCEEDED 0.0000","code":"920001","success":"X","front_end":"45"},"authorization":"EASE7anMb0;bankcard","success?":false,"test":false,"message":"CREDIT VOL EXCEEDED 0.0000"},"void_response":{},"_id":"544f7f93a9e7c041f8000347","account_id":"51a8dd097a0bfba2e8000003","amount":"1.01","authorization_id":"EASE7anMb0","cents":101,"created_at":"2014-10-28T11:35:47Z","credit_card_id":null,"currency":"USD","destination_id":"543553e275f9eb24c500015c","destination_identifier":"W9HV5184OQ","destination_kind":"sage-gateway-7","destination_name":"sage_gateway_7","destination_request_time":2.458855239,"gateway_order_id":"1xxxxxxxxxxx5362","identifier":"fb4912f5-d750-4856-8803-2121c74a1b07","kind":"refund","refunded_payment_id":"544f7b0575f9ebebcf000567","require_cvv":false,"updated_at":"2014-10-28T11:35:49Z","transaction_id":"EASE7anMb0","transacted":false,"status":"failure","void_status":"unvoided","refunded_payment":{"_id":{"$oid":"544f7b0575f9ebebcf000567"},"account_id":{"$oid":"51a8dd097a0bfba2e8000003"},"amount":"1.08","authorization_id":"BASE7GNhz0","captures":[],"cents":108,"created_at":"2014-10-28T11:16:21Z","credit_card_brand":null,"credit_card_id":{"$oid":"53887d9c91581cf07900007d"},"credit_card_identifier":"6605-5vy07-w61m7-154z2","currency":"USD","destination_id":{"$oid":"543553e275f9eb24c500015c"},"destination_identifier":"W9HV5184OQ","destination_kind":"sage-gateway-7","destination_name":"sage_gateway_7","destination_request_time":2.346666391,"first_name":"adam","gateway_order_id":"4370053","identifier":"c8710218-474d-4726-9895-9976868d968c","kind":"purchase","last_name":"Rosenthal","refunds":[],"require_cvv":false,"response":{"params":{"success":"A","code":"08734C","message":"APPROVED 08734C","front_end":"45","cvv_result":"P","avs_result":"Z","risk":"00","reference":"BASE7GNhz0","order_number":"4370053","recurring":"0"},"authorization":"BASE7GNhz0;bankcard","cvv_result":{"code":"P","message":"Not Processed"},"message":"APPROVED 08734C","avs_result":{"code":"Z","message":"Street address does not match, but 5-digit postal code matches.","street_match":"N","postal_match":"Y"},"test":false,"success?":true},"status":"success","transacted":true,"transaction_id":"BASE7GNhz0","updated_at":"2014-10-28T11:16:24Z","void_response":{},"void_status":"unvoided","zip":"10029","id":"544f7b0575f9ebebcf000567"},"destination":"W9HV5184OQ","credit_card":null,"links":[{"rel":"self","href":"https://api.value.io/v1/payments/544f7f93a9e7c041f8000347"},{"rel":"index","href":"https://api.value.io/v1/payments"}]}}}';
                        $http_code = 422;
                    } else if ($data['payment']['refunded_payment'] == '1234567890') {
                        $json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"422 Unprocessable Entity","errors":{"payment":{"gateway_error":[{"message":"Transaction rejected because the referenced original transaction is invalid."}]}},"data":{"payment":{"captures":[],"fraudulence":{"_id":"59b15b1175f9ebf9000004f8","confidence":-1,"blocked":false,"flagged":false},"gateway_options":{},"refunds":[],"response":{"params":{"RspDT":"2017-09-07T10:43:42.3420864","SiteId":"138279","LicenseId":"138281","GatewayRspMsg":"Transaction rejected because the referenced original transaction is invalid.","GatewayRspCode":"3","GatewayTxnId":"1967125204","DeviceId":"2175529"},"cvv_result":{"message":null,"code":null},"avs_result":{"message":null,"code":null,"street_match":null,"postal_match":null},"success?":false,"authorization":"1967125204","test":false,"message":"Transaction rejected because the referenced original transaction is invalid."},"_id":"59b15b1175f9ebf9000004f7","account_id":"51a8dd097a0bfba2e8000003","amount":"1.99","authorization_id":"1967125204","cents":199,"created_at":"2017-09-07T14:43:29Z","credit_card_brand":"visa","credit_card_id":"59a43076a9e7c040b60000db","credit_card_identifier":"6448-ywx8z-ma8et-b8x8b","credit_card_last_four":"3410","currency":"USD","cvv_to_destination":false,"destination_id":"59a422b675f9eb2ef2000c3b","destination_identifier":"CURRITO-XAVIER","destination_kind":"heartland","destination_name":"CURRITO-XAVIER","destination_request_time":0.469135409,"first_name":"Cary","zip":"80031","void_status":"unvoided","updated_at":"2017-09-07T14:43:29Z","transaction_id":"1967125204","gateway_order_id":"1504795409233432","identifier":"e70378a3-11d1-4206-9f02-33e78d10847c","kind":"refund","status":"failure","refunded_payment_id":"59a76ca9a9e7c051980003a1","require_cvv":false,"transacted":false,"last_name":"Russell","refunded_payment":{"_id":{"$oid": "59a76ca9a9e7c051980003a1"},"account_id":{"$oid": "51a8dd097a0bfba2e8000003"},"amount":"1.99","authorization_id":"1934850975","authorized_payment_id":{"$oid": "59a6c442a9e7c09f270002dd"},"captures":[],"cents":199,"created_at":"2017-08-31T01:55:53Z","credit_card_id":null,"credit_card_last_four":"3410","currency":"USD","cvv_to_destination":false,"destination_id":{"$oid": "59a422b675f9eb2ef2000c3b"},"destination_identifier":"CURRITO-XAVIER","destination_kind":"heartland","destination_name":"CURRITO-XAVIER","destination_request_time":0.35401225,"fraudulence":{"_id":{"$oid": "59a76ca9a9e7c051980003a2"},"confidence":-1,"blocked":false,"flagged":false},"gateway_options":{},"gateway_order_id":"1504144553320723","identifier":"2bf3bd2c-3732-45fb-9d46-c92cb767330a","kind":"capture","refunds":[],"require_cvv":false,"response":{"params":{"LicenseId":"138281","SiteId":"138279","DeviceId":"2175529","GatewayTxnId":"1934850975","GatewayRspCode":"0","GatewayRspMsg":"Success","RspDT":"2017-08-30T21:56:02.1003042"},"authorization":"1934850975","cvv_result":{"code":null,"message":null},"message":null,"avs_result":{"code":null,"message":null,"street_match":null,"postal_match":null},"test":false,"success?":true},"status":"success","transacted":true,"transacted_at":"2017-08-31T01:55:53Z","transaction_id":"1934850975","updated_at":"2017-08-31T01:55:53Z","void_status":"unvoided","id":"59a76ca9a9e7c051980003a1"},"destination":"CURRITO-XAVIER","credit_card":"6448-ywx8z-ma8et-b8x8b","links":[{"rel":"self","href":"https://api.value.io/v1/payments/59b15b1175f9ebf9000004f7"},{"rel":"index","href":"https://api.value.io/v1/payments"}]}}}';
                        $http_code = 422;
                    } else {
                        // normall successfull refund
                        $json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"200 OK","params":{"payment":{"kind":"refund"}}}';
                        $http_code = 200;
                    }
                } else if ($data['payment']['kind'] == 'void') {
                    // normall successfull refund
                    if (getProperty("force_void_fail") == 'true') {
                        $json_result = '{"path":"/payments","route":"/payments","mode":"put","status":"422 Unprocessable Entity","params":{"payment":{"kind":"void"}}}';
                        $http_code = 422;
                    } else if (true) {
                        $json_result = '{"path":"/paymen ts","route":"/payments","mode":"post","status":"200 OK","params":{"payment":{"kind":"void"}}}';
                        $http_code = 200;
                    } else {
                        // bad request error. need to build this test at some point. its generated from auth refersal sometime.  dont know why
                        $json_result = '{"path":"/payments/af0e9adb-5bc4-4c8a-8f2d-a6178f30e636","route":"/payments/:id","mode":"put","status":"422 Unprocessable Entity","errors":{"payment":{}},"data":{"payment":{"captures":[],"fraudulence":{"_id":"58e2bd4575f9ebdc02000296","confidence":-1,"blocked":false,"flagged":false},"gateway_options":{},"refunds":[],"response":{"cvv_result":{"code":null,"message":null},"avs_result":{"code":"Z","message":"Street address does not match, but 5-digit postal code matches.","street_match":"N","postal_match":"Y"},"params":{"merchant_address":"22724 MIDLAND DR","tax2_amount":"","tax2_number":"","secure_auth_required":"","secure_auth_result":"","ecommerce_flag":"","xid":"","cavv":"","cavv_algorithm":"","reference_no":"15578273","customer_ref":"","reference_3":"","language":"","client_ip":"","client_email":"","user_name":"","transaction_error":"false","transaction_type":"01","exact_resp_code":"00","exact_message":"Transaction Normal - Approved","bank_resp_code":"100","bank_message":"Approved","bank_resp_code_2":"","sequence_no":"0566602","avs":"Z","cvv2":"","retrieval_ref_no":"170403","cavv_response":"","currency":"USD","amount_requested":"","partial_redemption":"false","merchant_name":"GOODCENTS #174","tax1_number":"","merchant_city":"SHAWNEE","merchant_province":"Kansas","merchant_country":"United States","merchant_postal":"66226","merchant_url":"WWW.GOODCENTS.COM","transarmor_token":"","card_type":"Visa","current_balance":"","previous_balance":"","ean":"","card_cost":"","virtual_card":"false","ctr":"========== TRANSACTION RECORD ==========\nGOODCENTS #174\n22724 MIDLAND DR\nSHAWNEE, KS 66226\nUnited States\nWWW.GOODCENTS.COM\n\nTYPE: Pre-Authorization\n\nACCT: Visa $ 10.70 USD\n\nCARDHOLDER NAME : Chris Carmichael\nCARD NUMBER : ############6893\nDATE/TIME : 03 Apr 17 16:23:17\nREFERENCE # : 001 0566602 M\nAUTHOR. # : 09533D\nTRANS. REF. : 15578273\n\nApproved - Thank You 100\n\n\nPlease retain this copy for your records.\n\nCardholder will pay above amount to\ncard issuer pursuant to cardholder\nagreement.\n========================================","dollar_amount":"10.7","tax1_amount":"","zip_code":"","cvd_presence_ind":"0","password":"","exact_id":"M88201-28","verification_str1":"1881 9th Street|66226|Boulder|Colorado|US","card_holders_name":"Chris Carmichael","authorization_num":"09533D","pan":"","track2":"","track1":"","transaction_tag":"1868017934","surcharge_amount":"","transaction_approved":"true"},"authorization":"09533D;1868017934;107","success?":true,"test":false,"message":"Transaction Normal - Approved"},"void_response":{"params":{"transaction_approved":"false","error_number":"400","error_description":"Bad Request (69) - Invalid Transaction Tag","ecommerce_error_code":"69"},"cvv_result":{"code":null,"message":null},"avs_result":{"code":null,"message":null,"street_match":null,"postal_match":null},"success?":false,"test":false,"message":"Bad Request (69) - Invalid Transaction Tag","authorization":""},"_id":"58e2bd4575f9ebdc02000295","account_id":"51a8dd097a0bfba2e8000003","amount":"10.7","authorization_id":"09533D;1868017934;107","cents":1070,"created_at":"2017-04-03T21:23:17Z","credit_card_brand":"visa","credit_card_id":"589bb6c1a9e7c0a140000197","credit_card_identifier":"3753-719ya-5f815-12w73","credit_card_last_four":"6893","currency":"USD","cvv_to_destination":false,"destination_id":"56afa713a9e7c010ba0005d2","destination_identifier":"WRO67EE313","destination_kind":"payeezy","destination_name":"Payeezy Gateway 58","destination_request_time":1.080290683,"first_name":"Chris","void_status":"failure","updated_at":"2017-04-03T21:24:23Z","transaction_id":"09533D;1868017934;107","transacted_at":"2017-04-03T21:23:18Z","gateway_order_id":"15578273","identifier":"af0e9adb-5bc4-4c8a-8f2d-a6178f30e636","kind":"void","last_name":"Carmichael","require_cvv":false,"transacted":true,"status":"success","zip":"66226","links":[{"rel":"self","href":"https://api.value.io/v1/payments/58e2bd4575f9ebdc02000295"},{"rel":"index","href":"https://api.value.io/v1/payments"}]}}}';
                        $http_code = 422;
                    }
                } else if (strtolower($data['payment']['kind']) == 'authorize') {
					$generated_transaction_identifier = generateUUID();
                    $http_code = 200;
					if (substr($identifier,-5) == 'NOCVV') {
                        //$json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"200 OK","errors": {},"data": {"payment": {"captures": [],"refunds": [],"response": {"cvv_result": {"code":"N","message":"No Match"},"avs_result": {"street_match":"N","code":"Z","message":"Street address does not match, but 5-digit postal code matches.","postal_match":"Y"},"params": {"recurring":"0","risk":"00","order_number":"1xxxxxxxxxxx9593","reference":"E9TEGHh5j0","avs_result":"Z","cvv_result":"N","front_end":"45","code":"02316D","success":"A","message":"APPROVED 02316D"},"authorization":"E9TEGHh5j0;bankcard","success?": true,"test": true,"message":"APPROVED 02316D"},"void_response": {},"_id":"'.$transaction_id.'","account_id":"535fe8fd9811b4770a00000c","amount":"'.$amount.'","authorization_id":"E9TEGHh5j0","cents": 327,"created_at":"2014-09-29T20:17:40Z","credit_card_brand":"visa","credit_card_id":"5429be5edd39162f95000c07","credit_card_identifier":"8555-gd9gv-kvua5-dypxb","currency":"USD","destination_id":"54296bd3dd39168dbb0007a2","destination_identifier":"'.$destination_id.'","destination_kind":"sage-gateway-430","destination_name":"sage_gateway_430","destination_request_time": 3.985071173,"first_name":"Tarek","gateway_order_id":"1xxxxxxxxxxx9593","identifier":"'.$identifier.'2","kind":"purchase","last_name":"Dimachkie","require_cvv": false,"void_status":"unvoided","updated_at":"2014-09-29T20:17:45Z","status":"success","transaction_id":"RTY567RTY","transacted": true,"zip":"80020","destination":"'.$destination_id.'","credit_card":"'.$identifier.'","links": [{"rel":"self","href":"https://api-staging.value.io/v1/payments/5429be64dd39162f95000c08"},{"rel":"index","href":"https://api-staging.value.io/v1/payments"}]}}}';
                        $json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"200 OK","errors": {},"data": {"payment": {"captures": [],"fraudulence": {"_id":"56a108b3dd3916c391000185","confidence": -1,"blocked": false,"flagged": false},"refunds": [],"response": {"params": {"recurring":"0","order_number":"1453394099","front_end":"10","message":"APPROVED 000001","code":"000001","success":"A","reference":"B1LGBa1Ly0","risk":"00","avs_result":"","cvv_result":"N"},"cvv_result": {"code":"N","message":"No Match"},"avs_result": {"street_match": null,"code": null,"message": null,"postal_match": null},"success?": true,"test": true,"authorization":"B1LGBa1Ly0;bankcard","message":"APPROVED 000001"},"_id":"56a108b3dd3916c391000184","account_id":"535fe8fd9811b4770a00000c","address1":"1305 Pearl Street","amount":"1.00","authorization_id":"B1LGBa1Ly0","cents": 100,"city":"Boulder","country":"USA","created_at":"2016-01-21T16:34:59Z","credit_card_brand":"visa","credit_card_id":"56a10893dd3916c39100016c","credit_card_identifier":"8552-j614y-7kb54-gt065","credit_card_last_four":"1111","currency":"USD","destination_id":"56a108a4dd3916c391000179","destination_identifier":"'.$data['payment']['destination'].'","destination_kind":"sage","destination_name":"Sage Gateway 1539","destination_request_time": 0.754058508,"first_name":"sumdum","zip":"12345","void_status":"unvoided","updated_at":"2016-01-21T16:35:00Z","transaction_id":"B1LGBa1Ly0","gateway_order_id": 1453394099,"identifier":"'.$generated_transaction_identifier.'","kind":"authorize","last_name":"guy","state":"CO","transacted_at":"2016-01-21T16:35:00Z","transacted": true,"status":"success","require_cvv": false,"destination":"GL305JLQ063Y7BQ6U4D7","credit_card":"8552-j614y-7kb54-gt065","links": [{"rel":"self","href":"https://api-staging.value.io/v1/payments/56a108b3dd3916c391000184"},{"rel":"index","href":"https://api-staging.value.io/v1/payments"}]}}}';
                    } else if (substr($identifier,-5) == 'DUPLI') {
                        $json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"422 Unprocessable Entity","errors":{"payment":{"gateway_error":[{"message":"DUPLICATE TRANS"}]}},"data":{"payment":{"captures":[],"fraudulence":{"_id":"5a009404a9e7c01f06000be3","confidence":-1,"blocked":false,"flagged":false},"gateway_options":{},"refunds":[],"response":{"params":{"order_number":"17259175","recurring":"0","reference":"AB6HBvBJh0","risk":"00","code":"000000","success":"X","avs_result":"","cvv_result":"","front_end":"45","message":"DUPLICATE TRANS"},"cvv_result":{"code":null,"message":null},"avs_result":{"code":null,"message":null,"street_match":null,"postal_match":null},"success?":false,"test":false,"message":"DUPLICATE TRANS","authorization":"AB6HBvBJh0;bankcard"},"_id":"5a009403a9e7c01f06000be2","account_id":"51a8dd097a0bfba2e8000003","amount":"6.12","authorization_id":"AB6HBvBJh0","cents":612,"created_at":"2017-11-06T16:55:32Z","credit_card_brand":"visa","credit_card_id":"593eb21e75f9ebbca200044b","credit_card_identifier":"8726-2079k-mml39-oa4ji","credit_card_last_four":"1914","currency":"USD","cvv_to_destination":false,"destination_id":"5435a03ca9e7c0031a000455","destination_identifier":"C1HY6SSJH6","destination_kind":"sage","destination_name":"sage_gateway_8","destination_request_time":1.645500599,"first_name":"Emmanuel","zip":"32738","void_status":"unvoided","updated_at":"2017-11-06T16:55:36Z","transaction_id":"AB6HBvBJh0","gateway_order_id":"17259175","identifier":"a1d42caa-2ec8-45cf-9054-1cf58c6b9996","kind":"authorize","last_name":"Benitez","status":"failure","transacted":false,"require_cvv":false,"destination":"C1HY6SSJH6","credit_card":"8726-2079k-mml39-oa4ji","links":[{"rel":"self","href":"https://api.value.io/v1/payments/5a009403a9e7c01f06000be2"},{"rel":"index","href":"https://api.value.io/v1/payments"}]}}}';
                        $http_code = 422;
                    } else {
                        $json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"200 OK","errors": {},"data": {"payment": {"captures": [],"fraudulence": {"_id":"56a108b3dd3916c391000185","confidence": -1,"blocked": false,"flagged": false},"refunds": [],"response": {"params": {"recurring":"0","order_number":"1453394099","front_end":"10","message":"APPROVED 000001","code":"000001","success":"A","reference":"B1LGBa1Ly0","risk":"00","avs_result":"","cvv_result":"M"},"cvv_result": {"code":"M","message":"CVV matches"},"avs_result": {"street_match": null,"code": null,"message": null,"postal_match": null},"success?": true,"test": true,"authorization":"B1LGBa1Ly0;bankcard","message":"APPROVED 000001"},"_id":"56a108b3dd3916c391000184","account_id":"535fe8fd9811b4770a00000c","address1":"1305 Pearl Street","amount":"1.00","authorization_id":"B1LGBa1Ly0","cents": 100,"city":"Boulder","country":"USA","created_at":"2016-01-21T16:34:59Z","credit_card_brand":"visa","credit_card_id":"56a10893dd3916c39100016c","credit_card_identifier":"8552-j614y-7kb54-gt065","credit_card_last_four":"1111","currency":"USD","destination_id":"56a108a4dd3916c391000179","destination_identifier":"'.$data['payment']['destination'].'","destination_kind":"sage","destination_name":"Sage Gateway 1539","destination_request_time": 0.754058508,"first_name":"sumdum","zip":"12345","void_status":"unvoided","updated_at":"2016-01-21T16:35:00Z","transaction_id":"B1LGBa1Ly0","gateway_order_id": 1453394099,"identifier":"'.$generated_transaction_identifier.'","kind":"authorize","last_name":"guy","state":"CO","transacted_at":"2016-01-21T16:35:00Z","transacted": true,"status":"success","require_cvv": false,"destination":"GL305JLQ063Y7BQ6U4D7","credit_card":"8552-j614y-7kb54-gt065","links": [{"rel":"self","href":"https://api-staging.value.io/v1/payments/56a108b3dd3916c391000184"},{"rel":"index","href":"https://api-staging.value.io/v1/payments"}]}}}';
                    }

				} else if (strtolower($data['payment']['kind']) == 'capture') {
					if ($data['payment']['amount'] == 10) {
						$json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"422 Unprocessable Entity","errors":{  "payment":{  "gateway_error":[  {  "message":"SUM DUM ERROR"}]}}}';
						$http_code = 422;
                    } else if ($data['payment']['authorized_payment'] == 'fail-12345-12345-12345') {
                        $json_result = '{ "path":"/payments", "route":"/payments", "mode":"post", "status":"422 Unprocessable Entity", "errors":{"payment":{ "exception":[{ "message":"The remote server reset the connection"} ]} }, "data":{"payment":{ "response":{ "exception": "The remote server reset the connection" }, "void_response":{ }, "_id":"53a8b3b5dd3916cbf800011b", "account_id":"535fe8fd9811b4770a00000c", "amount":"16.00", "authorization_id":"A6NEJ9hKy0", "cents":1600, "created_at":"2014-06-23T23:09:42Z", "credit_card_id":"53a8b3a9dd3916cbf8000116", "currency":"USD", "destination_id":"53a8b3a0dd3916cbf8000112", "identifier":"4764fffd-ef95-4bd6-a43c-bda483b3071a", "kind":"capture", "updated_at":"2014-06-23T23:09:42Z", "transaction_id":"A6NEJ9hKy0", "transacted":false, "status":"failure", "void_status":"unvoided", "destination":"8PX6X70I6KBQDA1GHH75", "credit_card":"3852-fhtt-oy5w-b440", "links":[{ "rel":"self", "href":"https://api-staging.value.io/v1/payments/53a8b3b5dd3916cbf800011b"},{ "rel":"index", "href":"https://api-staging.value.io/v1/payments"} ]} }, "account":{"slug":"splikit" }, "token":{"uuid":"05bfd758-5e1a-4ceb-bb39-f64b60d99d30","roles":[ "admin"] }}';
                        $http_code = 422;
                    } else {
						$destination = $data['payment']['destination'];
						$json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"200 OK","errors": {},"data": {"payment": {"captures": [],"fraudulence": {"_id":"56a108c4dd3916c391000187","confidence": -1,"blocked": false,"flagged": false},"refunds": [],"response": {"params": {"recurring":"0","message":"APPROVED 000001","order_number":"1453394099","reference":"B1LGBa1Ly0","success":"A","risk":"00","avs_result":"","cvv_result":"P","front_end":"10","code":"000001"},"cvv_result": {"code":"P","message":"CVV not processed"},"avs_result": {"code": null,"message": null,"street_match": null,"postal_match": null},"authorization":"B1LGBa1Ly0;bankcard","success?": true,"test": true,"message":"APPROVED 000001"},"_id":"56a108c4dd3916c391000186","account_id":"535fe8fd9811b4770a00000c","amount": 1,"authorization_id":"B1LGBa1Ly0","authorized_payment_id":"56a108b3dd3916c391000184","cents": 100,"created_at":"2016-01-21T16:35:16Z","credit_card_id": null,"credit_card_last_four":"1111","currency":"USD","destination_id":"56a108a4dd3916c391000179","destination_identifier":"'.$destination.'","destination_kind":"sage","destination_name":"Sage Gateway 1539","destination_request_time": 0.541529454,"updated_at":"2016-01-21T16:35:17Z","transaction_id":"B1LGBa1Ly0","transacted_at":"2016-01-21T16:35:17Z","transacted": true,"gateway_order_id":"1xxxxxxxxxxx1426","identifier":"c42315d6-1d76-4948-8cfa-c3ac38e4669b","kind":"capture","require_cvv": false,"status":"success","void_status":"unvoided","authorized_payment": {"_id": {"$oid":"56a108b3dd3916c391000184"},"account_id": {"$oid":"535fe8fd9811b4770a00000c"},"address1":"1305 Pearl Street","amount":"1.00","authorization_id":"B1LGBa1Ly0","captures": [],"cents": 100,"city":"Boulder","country":"USA","created_at":"2016-01-21T16:34:59Z","credit_card_brand":"visa","credit_card_id": {"$oid":"56a10893dd3916c39100016c"},"credit_card_identifier":"8552-j614y-7kb54-gt065","credit_card_last_four":"1111","currency":"USD","destination_id": {"$oid":"56a108a4dd3916c391000179"},"destination_identifier":"GL305JLQ063Y7BQ6U4D7","destination_kind":"sage","destination_name":"Sage Gateway 1539","destination_request_time": 0.754058508,"first_name":"sumdum","fraudulence": {"_id": {"$oid":"56a108b3dd3916c391000185"},"confidence": -1,"blocked": false,"flagged": false},"gateway_order_id":"1453394099","identifier":"61591249-47a9-4c58-bd61-66db8540f848","kind":"authorize","last_name":"guy","refunds": [],"require_cvv": false,"response": {"params": {"success":"A","code":"000001","message":"APPROVED 000001","front_end":"10","cvv_result":"M","avs_result":"","risk":"00","reference":"B1LGBa1Ly0","order_number":"1453394099","recurring":"0"},"authorization":"B1LGBa1Ly0;bankcard","cvv_result": {"code":"M","message":"CVV matches"},"message":"APPROVED 000001","avs_result": {"code": null,"message": null,"street_match": null,"postal_match": null},"test": true,"success?": true},"state":"CO","status":"success","transacted": true,"transacted_at":"2016-01-21T16:35:00Z","transaction_id":"B1LGBa1Ly0","updated_at":"2016-01-21T16:35:00Z","void_status":"unvoided","zip":"12345","id":"56a108b3dd3916c391000184"},"links": [{"rel":"self","href":"https://api-staging.value.io/v1/payments/56a108c4dd3916c391000186"},{"rel":"index","href":"https://api-staging.value.io/v1/payments"}]}}}';
						$http_code = 200;
					}
				} else if ($identifier == '1234-5678-9012-3456' || (substr($identifier, -4) == 'DECL') ) {
                    // declined
					$json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"422 Unprocessable Entity","errors": {"payment": {"gateway_error": [        {"message": null        }      ]    }  },"data": {"payment": {"response": {"params": {"avs_result":"","order_number":"2id71157dy91orwruqh","recurring":"0","cvv_result":"N","risk":"00","front_end":"10","message":"DECLINED","code":"000002","success":"E","reference":"A6NEHGFFH0"        },"avs_result": {"message": null,"code": null,"street_match": null,"postal_match": null        },"cvv_result": {"code":"N","message":"No Match"        },"authorization":"A6NEHGFFH0;bankcard","success?": false,"test": true,"message":"DECLINED"      },"void_response": {      },"_id":"53a8991edd3916cbf8000059","account_id":"535fe8fd9811b4770a00000c","amount":"2.00","authorization_id":"A6NEHGFFH0","cents": 200,"created_at":"2014-06-23T21:16:14Z","credit_card_id":"53a8991add3916cbf8000057","currency":"USD","destination_id":"53a89911dd3916cbf8000053","identifier":"c8aff256-9ea2-4815-bbcd-1881058ba64d","kind":"purchase","updated_at":"2014-06-23T21:16:15Z","transaction_id":"A6NEHGFFH0","transacted": false,"status":"failure","void_status":"unvoided","destination":"Y6T2KFG1XWCHIXM2FVH5","credit_card":"3478-62zg-ogm8-47rx","links": [        {"rel":"self","href":"https://api-staging.value.io/v1/payments/53a8991edd3916cbf8000059"        },        {"rel":"index","href":"https://api-staging.value.io/v1/payments"        }      ]    }  },"account": {"slug":"splikit"  },"token": {"uuid":"05bfd758-5e1a-4ceb-bb39-f64b60d99d30","roles": ["admin"    ]  }}';
					$http_code = 422;
                } else if ($identifier == '1234-5678-9012-XXXX') {
                    $json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"422 Unprocessable Entity","errors": {"payment": {"gateway_error": [        {"message": null        }      ]    }  },"data": {"payment": {"response": {"params": {"avs_result":"","order_number":"2id7lh96hiwj2fral97","recurring":"0","cvv_result":"P","risk":"00","front_end":"10","message":"UNABLE TO PROCESS","code":"999999","success":"X","reference":"A6NEJ9hKy0"        },"avs_result": {"message": null,"code": null,"street_match": null,"postal_match": null        },"cvv_result": {"code":"P","message":"Not Processed"        },"authorization":"A6NEJ9hKy0;bankcard","success?": false,"test": true,"message":"UNABLE TO PROCESS"      },"void_response": {      },"_id":"53a8b3b5dd3916cbf800011b","account_id":"535fe8fd9811b4770a00000c","amount":"16.00","authorization_id":"A6NEJ9hKy0","cents": 1600,"created_at":"2014-06-23T23:09:42Z","credit_card_id":"53a8b3a9dd3916cbf8000116","currency":"USD","destination_id":"53a8b3a0dd3916cbf8000112","identifier":"4764fffd-ef95-4bd6-a43c-bda483b3071a","kind":"purchase","updated_at":"2014-06-23T23:09:42Z","transaction_id":"A6NEJ9hKy0","transacted": false,"status":"failure","void_status":"unvoided","destination":"8PX6X70I6KBQDA1GHH75","credit_card":"3852-fhtt-oy5w-b440","links": [        {"rel":"self","href":"https://api-staging.value.io/v1/payments/53a8b3b5dd3916cbf800011b"        },        {"rel":"index","href":"https://api-staging.value.io/v1/payments"        }      ]    }  },"account": {"slug":"splikit"  },"token": {"uuid":"05bfd758-5e1a-4ceb-bb39-f64b60d99d30","roles": ["admin"    ]  }}';
                    $http_code = 422;
                } else if ($identifier == '12340-56789-BLANK-CARDX') {
                    $json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"422 Unprocessable Entity","errors":{"payment":{"credit_card":["cannot purchase with blank credit_card"]}},"data":{"payment":{"captures":[],"refunds":[],"fraudulence":{"_id":"556cba9075f9eb0c5f000285","confidence":-1,"blocked":false,"flagged":false},"_id":"556cba9075f9eb0c5f000284","kind":"purchase","currency":"USD","status":"new","void_status":"unvoided","gateway_order_id":"7123183","destination_id":"543553e275f9eb24c500015c","credit_card_id":null,"amount":"12.25","account_id":"51a8dd097a0bfba2e8000003","transacted":false,"identifier":"33ce1770-133e-407c-aeca-ea9b2cf65f96","created_at":"2015-06-01T20:03:28Z","cents":1225,"transaction_id":null,"destination_name":"sage_gateway_7","destination_kind":"sage","destination_identifier":"W9HV5184OQ","updated_at":"2015-06-01T20:03:28Z","require_cvv":false,"destination":"W9HV5184OQ","credit_card":"12340-56789-BLANK-CARDX","links":[{"rel":"self","href":"https://api.value.io/v1/payments/556cba9075f9eb0c5f000284"},{"rel":"index","href":"https://api.value.io/v1/payments"}]}}}';
                    $http_code = 422;
                } else if ($identifier == '12340-56789-SERVE-RESET') {
                    $json_result = '{ "path":"/payments", "route":"/payments", "mode":"post", "status":"422 Unprocessable Entity", "errors":{"payment":{ "exception":[{ "message":"The remote server reset the connection", "class":"ActiveMerchant::ConnectionError", "backtrace":[]} ]} }, "data":{"payment":{ "captures":[ ], "fraudulence":{"flagged":false,"blocked":false,"confidence":-1,"_id":"5579e4c5a9e7c0cf8b00055e" }, "refunds":[ ], "response":{"exception":"The remote server reset the connection" }, "_id":"5579e4c5a9e7c0cf8b00055d", "account_id":"51a8dd097a0bfba2e8000003", "amount":"8.51", "cents":851, "created_at":"2015-06-11T19:43:01Z", "credit_card_brand":"visa", "credit_card_id":"53bdddef3xxxxxxxxxxx2395", "credit_card_identifier":"5067-7k61n-cokkm-9goq8", "credit_card_last_four":"2945", "currency":"USD", "destination_id":"547e0c73a9e7c092f00001d4", "destination_identifier":"M624K9SSHR", "destination_kind":"mercury", "destination_name":"mercury_gateway_66", "first_name":"Darian", "status":"failure", "void_status":"unvoided", "updated_at":"2015-06-11T19:43:06Z", "transaction_id":null, "gateway_order_id":"7322114", "identifier":"72044ded-39e0-4b11-a502-d2ea731dda3d", "kind":"purchase", "last_name":"Grooms", "require_cvv":false, "transacted":false, "zip":"30041", "destination":"M624K9SSHR", "credit_card":"5067-7k61n-cokkm-9goq8", "links":[{ "rel":"self", "href":"https://api.value.io/v1/payments/5579e4c5a9e7c0cf8b00055d"},{ "rel":"index", "href":"https://api.value.io/v1/payments"} ]} }}';
                    $http_code = 422;
                } else if ($identifier == '12340-56789-INVLD-NUMBR') {
                    $json_result = '{"path":"/payments", "route":"/payments", "mode":"post", "status":"422 Unprocessable Entity", "errors":{ "payment":{"exception":[ {"message":"undefined method `responseMessage for \"Invalid Account Number\":String", "class":"NoMethodError", "backtrace":[]} ]} }, "data":{ "payment":{"captures":[ ], "fraudulence":{ "flagged":false,"blocked":false,"confidence":-1,"_id":"5579c5e7a9e7c099ac000143" }, "refunds":[ ], "response":{ "exception":"undefined method `responseMessage for \"Invalid Account Number\":String" }, "_id":"5579c5e7a9e7c099ac000142", "account_id":"51a8dd097a0bfba2e8000003", "amount":"29.97", "authorization_id":"865709049", "cents":2997, "created_at":"2015-06-11T17:31:19Z", "credit_card_brand":"visa", "credit_card_id":"54fcc472a9e7c0ad5e000795", "credit_card_identifier":"2241-20t0z-l4x42-665t1", "credit_card_last_four":"1882", "currency":"USD", "destination_id":"548b364575f9eb4cab0003da", "destination_identifier":"2283HKOMQ5", "destination_kind":"usa-epay", "destination_name":"usa_epay_gateway_14", "destination_request_time":1.452021164, "status":"failure", "zip":"27360", "void_status":"unvoided", "updated_at":"2015-06-11T17:31:21Z", "transaction_id":null, "gateway_order_id":"7318531", "identifier":"975458d7-0b28-4f98-82d7-4fbfbcc5b797", "kind":"purchase", "last_name":"Aguirre", "require_cvv":false, "transacted":false, "first_name":"Gerardo", "destination":"2283HKOMQ5", "credit_card":"2241-20t0z-l4x42-665t1", "links":[ {"rel":"self", "href":"https://api.value.io/v1/payments/5579c5e7a9e7c099ac000142"},{"rel":"index", "href":"https://api.value.io/v1/payments"} ]} }}';
                    $http_code = 422;
                } else if ($identifier == '12345-56789-error-vcurl') {
                    $response['error'] = "SSL peer certificate or SSH remote key was not OK";
                    $response['error_no'] = 51;
                    $response['http_code'] = 0;
                    return $response;
                } else if ($identifier == '1234-5678-9012-8888') {
					$json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"422 Unprocessable Entity","errors": {"payment": {"gateway_error": [        {"message": null        }      ]    }  },"data": {"payment": {"response": {"params": {"avs_result":"","order_number":"2id7lh96hiwj2fral97","recurring":"0","cvv_result":"P","risk":"00","front_end":"10","message":"BADPERSON","code":"999999","success":"X","reference":"A6NEJ9hKy0"        },"avs_result": {"message": null,"code": null,"street_match": null,"postal_match": null        },"cvv_result": {"code":"P","message":"Not Processed"        },"authorization":"A6NEJ9hKy0;bankcard","success?": false,"test": true,"message":"BADPERSON"      },"void_response": {      },"_id":"53a8b3b5dd3916cbf800011b","account_id":"535fe8fd9811b4770a00000c","amount":"16.00","authorization_id":"A6NEJ9hKy0","cents": 1600,"created_at":"2014-06-23T23:09:42Z","credit_card_id":"53a8b3a9dd3916cbf8000116","currency":"USD","destination_id":"53a8b3a0dd3916cbf8000112","identifier":"4764fffd-ef95-4bd6-a43c-bda483b3071a","kind":"purchase","updated_at":"2014-06-23T23:09:42Z","transaction_id":"A6NEJ9hKy0","transacted": false,"status":"failure","void_status":"unvoided","destination":"8PX6X70I6KBQDA1GHH75","credit_card":"3852-fhtt-oy5w-b440","links": [        {"rel":"self","href":"https://api-staging.value.io/v1/payments/53a8b3b5dd3916cbf800011b"        },        {"rel":"index","href":"https://api-staging.value.io/v1/payments"        }      ]    }  },"account": {"slug":"splikit"  },"token": {"uuid":"05bfd758-5e1a-4ceb-bb39-f64b60d99d30","roles": ["admin"    ]  }}';
					$http_code = 422;
				} else if ($data['payment']['destination'] == 'sumdumdestination') {
					$json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"422 Unprocessable Entity","errors": {"payment": {"gateway_error": [        {"message": null        }      ]    }  },"data": {"payment": {"response": {"params": {"avs_result":"","order_number":"2id7lh96hiwj2fral97","recurring":"0","cvv_result":"P","risk":"00","front_end":"10","message":"BADDESTINATION","code":"999999","success":"X","reference":"A6NEJ9hKy0"        },"avs_result": {"message": null,"code": null,"street_match": null,"postal_match": null        },"cvv_result": {"code":"P","message":"Not Processed"        },"authorization":"A6NEJ9hKy0;bankcard","success?": false,"test": true,"message":"BADDESTINATION"      },"void_response": {      },"_id":"53a8b3b5dd3916cbf800011b","account_id":"535fe8fd9811b4770a00000c","amount":"16.00","authorization_id":"A6NEJ9hKy0","cents": 1600,"created_at":"2014-06-23T23:09:42Z","credit_card_id":"53a8b3a9dd3916cbf8000116","currency":"USD","destination_id":"53a8b3a0dd3916cbf8000112","identifier":"4764fffd-ef95-4bd6-a43c-bda483b3071a","kind":"purchase","updated_at":"2014-06-23T23:09:42Z","transaction_id":"A6NEJ9hKy0","transacted": false,"status":"failure","void_status":"unvoided","destination":"8PX6X70I6KBQDA1GHH75","credit_card":"3852-fhtt-oy5w-b440","links": [        {"rel":"self","href":"https://api-staging.value.io/v1/payments/53a8b3b5dd3916cbf800011b"        },        {"rel":"index","href":"https://api-staging.value.io/v1/payments"        }      ]    }  },"account": {"slug":"splikit"  },"token": {"uuid":"05bfd758-5e1a-4ceb-bb39-f64b60d99d30","roles": ["admin"    ]  }}';
					$http_code = 422;
                } else if ($identifier == 'fail-12345-12345-12345') {
                    $json_result = '{ "path":"/payments", "route":"/payments", "mode":"post", "status":"422 Unprocessable Entity", "errors":{"payment":{ "exception":[{ "message":"The remote server reset the connection"} ]} }, "data":{"payment":{ "response":{ "exception": "The remote server reset the connection" }, "void_response":{ }, "_id":"53a8b3b5dd3916cbf800011b", "account_id":"535fe8fd9811b4770a00000c", "amount":"16.00", "authorization_id":"A6NEJ9hKy0", "cents":1600, "created_at":"2014-06-23T23:09:42Z", "credit_card_id":"53a8b3a9dd3916cbf8000116", "currency":"USD", "destination_id":"53a8b3a0dd3916cbf8000112", "identifier":"4764fffd-ef95-4bd6-a43c-bda483b3071a", "kind":"purchase", "updated_at":"2014-06-23T23:09:42Z", "transaction_id":"A6NEJ9hKy0", "transacted":false, "status":"failure", "void_status":"unvoided", "destination":"8PX6X70I6KBQDA1GHH75", "credit_card":"3852-fhtt-oy5w-b440", "links":[{ "rel":"self", "href":"https://api-staging.value.io/v1/payments/53a8b3b5dd3916cbf800011b"},{ "rel":"index", "href":"https://api-staging.value.io/v1/payments"} ]} }, "account":{"slug":"splikit" }, "token":{"uuid":"05bfd758-5e1a-4ceb-bb39-f64b60d99d30","roles":[ "admin"] }}';
                    $http_code = 422;
                } else {
					$amount = $data['payment']['amount'];
					$destination_id = $data['payment']['destination'];					
					$transaction_id = strtolower(generateCode(20));
					$_SERVER['transaction_id'] = $transaction_id;
					if ($identifier == 'cvvpp-12345-12345-12345') {
						//cvv pass
						$json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"200 OK","data":{"payment":{"kind":"purchase","amount":"'.$amount.'","destination":"garett_inspire","credit_card":"garett_visa"},"controller":"api","action":"index","path":"payments/purchase","api":{"kind":"purchase","payment":{"amount":"'.$amount.'","destination":"garett_inspire","credit_card":"garett_visa","test":"true"}}},"errors":{},"data": {"payment":{"response":{"cvv_result": {"message": "Match","code": "M"},"avs_result": {"postal_match": null,"code": null,"message": null,"street_match": null},"params": {"reference": "F9IEGgehk0","recurring": "0","order_number": "1xxxxxxxxxxx6285","risk": "00","avs_result": "","cvv_result": "M","front_end": "10","message": "APPROVED 000001","success": "A","code": "000001"},"authorization": "F9IEGgehk0;bankcard","success?": true,"test": true,"message": "APPROVED 000001"},"_id":"536955be9811b433ec000001","currency":"USD","status":"new","amount":"'.$amount.'","account_id":"535feb399811b4770a000011","destination_id":"'.$destination_id.'","credit_card_id":"536916449811b40109000005","identifier":"'.$identifier.'","cents":1050,"transaction_id":"'.$transaction_id.'","updated_at":"2014-05-06T21:35:58Z","created_at":"2014-05-06T21:35:58Z","destination":"garett_inspire","credit_card":"garett_visa","links":[{"rel":"self","href":"https://api-staging.value.io/v1/payments/536955be9811b433ec000001"},{"rel":"index","href":"https://api-staging.value.io/v1/payments"}]}},"account":{"slug":"garett"},"token":{"uuid":"...","roles":["admin"]}}';
					} else if ($identifier == 'cvvxx-12345-12345-12345') {
                        //cvv does not exist
                        $json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"200 OK","data":{"payment":{"kind":"purchase","amount":"' . $amount . '","destination":"garett_inspire","credit_card":"garett_visa"},"controller":"api","action":"index","path":"payments/purchase","api":{"kind":"purchase","payment":{"amount":"' . $amount . '","destination":"garett_inspire","credit_card":"garett_visa","test":"true"}}},"errors":{},"data": {"payment":{"response":{"avs_result": {"postal_match": null,"code": null,"message": null,"street_match": null},"params": {"reference": "F9IEGgehk0","recurring": "0","order_number": "1xxxxxxxxxxx6285","risk": "00","avs_result": "","cvv_result": "M","front_end": "10","message": "APPROVED 000001","success": "A","code": "000001"},"authorization": "F9IEGgehk0;bankcard","success?": true,"test": true,"message": "APPROVED 000001"},"_id":"536955be9811b433ec000001","currency":"USD","status":"new","amount":"' . $amount . '","account_id":"535feb399811b4770a000011","destination_id":"' . $destination_id . '","credit_card_id":"536916449811b40109000005","identifier":"' . $identifier . '","cents":1050,"transaction_id":"' . $transaction_id . '","updated_at":"2014-05-06T21:35:58Z","created_at":"2014-05-06T21:35:58Z","destination":"garett_inspire","credit_card":"garett_visa","links":[{"rel":"self","href":"https://api-staging.value.io/v1/payments/536955be9811b433ec000001"},{"rel":"index","href":"https://api-staging.value.io/v1/payments"}]}},"account":{"slug":"garett"},"token":{"uuid":"...","roles":["admin"]}}';
                    } else {
						//$json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"200 OK","data":{"payment":{"kind":"purchase","amount":"'.$amount.'","destination":"garett_inspire","credit_card":"garett_visa"},"controller":"api","action":"index","path":"payments/purchase","api":{"kind":"purchase","payment":{"amount":"'.$amount.'","destination":"garett_inspire","credit_card":"garett_visa","test":"true"}}},"errors":{},"data": {"payment":{"response":{"cvv_result": {"message": "No Match","code": "N"},"avs_result": {"postal_match": null,"code": null,"message": null,"street_match": null},"params": {"reference": "F9IEGgehk0","recurring": "0","order_number": "1xxxxxxxxxxx6285","risk": "00","avs_result": "","cvv_result": "F","front_end": "10","message": "APPROVED 000001","success": "A","code": "000001"},"authorization": "F9IEGgehk0;bankcard","success?": true,"test": true,"message": "APPROVED 000001"},"_id":"536955be9811b433ec000001","currency":"USD","status":"new","amount":"'.$amount.'","account_id":"535feb399811b4770a000011","destination_id":"'.$destination_id.'","credit_card_id":"536916449811b40109000005","identifier":"'.$identifier.'","cents":1050,"transaction_id":"'.$transaction_id.'","updated_at":"2014-05-06T21:35:58Z","created_at":"2014-05-06T21:35:58Z","destination":"garett_inspire","credit_card":"garett_visa","links":[{"rel":"self","href":"https://api-staging.value.io/v1/payments/536955be9811b433ec000001"},{"rel":"index","href":"https://api-staging.value.io/v1/payments"}]}},"account":{"slug":"garett"},"token":{"uuid":"...","roles":["admin"]}}';
						$json_result = '{"path":"/payments","route":"/payments","mode":"post","status":"200 OK","errors": {},"data": {"payment": {"captures": [],"refunds": [],"response": {"cvv_result": {"code":"N","message":"No Match"},"avs_result": {"street_match":"N","code":"Z","message":"Street address does not match, but 5-digit postal code matches.","postal_match":"Y"},"params": {"recurring":"0","risk":"00","order_number":"1xxxxxxxxxxx9593","reference":"E9TEGHh5j0","avs_result":"Z","cvv_result":"N","front_end":"45","code":"02316D","success":"A","message":"APPROVED 02316D"},"authorization":"E9TEGHh5j0;bankcard","success?": true,"test": true,"message":"APPROVED 02316D"},"void_response": {},"_id":"'.$transaction_id.'","account_id":"535fe8fd9811b4770a00000c","amount":"'.$amount.'","authorization_id":"E9TEGHh5j0","cents": 327,"created_at":"2014-09-29T20:17:40Z","credit_card_brand":"visa","credit_card_id":"5429be5edd39162f95000c07","credit_card_identifier":"8555-gd9gv-kvua5-dypxb","currency":"USD","destination_id":"54296bd3dd39168dbb0007a2","destination_identifier":"'.$destination_id.'","destination_kind":"sage-gateway-430","destination_name":"sage_gateway_430","destination_request_time": 3.985071173,"first_name":"Tarek","gateway_order_id":"1xxxxxxxxxxx9593","identifier":"'.$identifier.'2","kind":"purchase","last_name":"Dimachkie","require_cvv": false,"void_status":"unvoided","updated_at":"2014-09-29T20:17:45Z","status":"success","transaction_id":"RTY567RTY","transacted": true,"zip":"80020","destination":"'.$destination_id.'","credit_card":"'.$identifier.'","links": [{"rel":"self","href":"https://api-staging.value.io/v1/payments/5429be64dd39162f95000c08"},{"rel":"index","href":"https://api-staging.value.io/v1/payments"}]}}}';						
					}
					$http_code = "200";
				}
			}
		} else if (substr_count($url, "/credit_cards")) {
			if ($data) {
                $identifier = $data['credit_card']['identifier'];
                $first_name = $data['credit_card']['first_name'];
                $last_name = $data['credit_card']['last_name'];
                $id = strtolower(generateCode(20));
                $json_result = '{"path":"/credit_cards","route":"/credit_cards","mode":"post","status":"200 OK","params":{"credit_card":{"identifier":"' . $identifier . '","brand":"visa","number":"4111111111111111","cvv":"123","month":10,"year":2020,"first_name":"sumdum","last_name":"guy"},"controller":"api","action":"index","path":"credit_cards","api":{"credit_card":{"identifier":"' . $identifier . '","brand":"visa","number":"4111111111111111","cvv":"123","month":10,"year":2020,"first_name":"' . $first_name . '","last_name":"' . $last_name . '"}}},"errors":{},"data":{"credit_card":{"id":"' . $id . '","account_id":"535fe8fd9811b4770a00000c","identifier":"' . $identifier . '","brand":"visa","number":"XXXX-XXXX-XXXX-1111","month":10,"year":2020,"first_name":"' . $first_name . '","last_name":"' . $last_name . '","archived":false,"updated_at":"2014-05-08T20:21:11Z","created_at":"2014-05-08T20:21:11Z","data":null,"cvv":"XXX","links":[{"rel":"self","href":"https://api-staging.value.io/v1/credit_cards/2275-065r-l5h9-x3ss"},{"rel":"index","href":"https://api-staging.value.io/v1/credit_cards"}]}},"account":{"slug":"splikit"},"token":{"uuid":"ac3b99e4-0d0c-4369-a70d-f44d56a874fc","roles":["write_only"]}}';
                $http_code = "200";
            } if (substr_count($url, "/credit_cards/FFFFF-FFFFF-FFFFF-FFFFF")) {
                $json_result = '{"errors":[{"not_found":"\nProblem:\nDocument not found for class CreditCard with attributes [[\"controller\", \"api\"], [\"action\", \"index\"], [\"path\", \"credit_cards/5204-5m337-df379-9ww8f\"], [\"id\", \"5204-5m337-df379-9ww8f\"]].\nSummary:\nWhen calling CreditCard.find_by with a hash of attributes, all attributes provided must match a document in the database or this error will be raised.\nResolution:\nSearch for attributes that are in the database or set the Mongoid.raise_not_found_error configuration option to false, which will cause a nil to be returned instead of raising this error."}]}';
                $http_code = "404";
            } else {
				// must be a card get
				$month = 5;
				$year = 2019;
				if (substr($url, -5) == 'zzzzz') {
					$year = 2014;
				} else if (substr($url, -5) == 'rand') {
					$last_four = rand(1112,9999);
				} else {
					$last_four = '1111';
				}

				$json_result = '{"path":"/credit_cards/3212-3ybc9-565gu-yskkl","route":"/credit_cards/:id","mode":"get","status":"200 OK","errors": {},"data": {"credit_card": {"id":"5449699add3916d289001058","account_id":"535fe8fd9811b4770a00000c","tokens": [{"created_at":"2014-10-23T20:48:27Z","updated_at":"2014-10-23T20:48:27Z","expired": false,"uuid":"72973ea7-cec9-421c-bc32-6ce5ecd8d2f4","single_use": true,"_id":"5449699bdd3916d289001059"}],"address1":"1305 Pearl Street","brand":"visa","city":"Boulder","country":"USA","created_at":"2014-10-23T20:48:27Z","first_name":"sumdum","identifier":"3212-3ybc9-565gu-yskkl","last_name":"guy","month": '.$month.',"number":"XXXX-XXXX-XXXX-'.$last_four.'","updated_at":"2014-10-23T20:48:27Z","zip":"12345","year": '.$year.',"vaulted": true,"state":"CO","data": null,"cvv":"XXX","links": [{"rel":"self","href":"https://api-staging.value.io/v1/credit_cards/3212-3ybc9-565gu-yskkl"},{"rel":"index","href":"https://api-staging.value.io/v1/credit_cards"}]}}}';
				$http_code = "200";
			}
		} else if (substr_count($url, "/destinations")) {
			$destination = $data['destination'];
			$config = $destination['config'];
			$identifier = $destination['identifier'];
			if ($destination['type'] == 'sage') {
				//array("merchant_id_key","merchant_id_number");
				$id = rand(1000000000, 9999999999);
				$merchant_id_key = $config['merchant_id_key'];
				$merchant_id_number = $config['merchant_id_number'];
				$json_result = '{"path":"/destinations","route":"/destinations","mode":"post","status":"200 OK","params":{"destination":{"type":"sage","identifier":"'.$identifier.'","config":{"merchant_id_number":"'.$merchant_id_number.'","merchant_id_key":"'.$merchant_id_key.'"}},"controller":"api","action":"index","path":"destinations","api":{"destination":{"type":"sage","identifier":"'.$identifier.'","config":{"merchant_id_number":"'.$merchant_id_number.'","merchant_id_key":"'.$merchant_id_key.'"}}}},"errors":{},"data":{"destination":{"id":"'.$id.'","account_id":"535fe8fd9811b4770a00000c","config":{"merchant_id_key":"'.$merchant_id_key.'","merchant_id_number":"'.$merchant_id_number.'"},"_type":"Gateway::Sage","identifier":"'.$identifier.'","created_at":"2014-05-07T22:12:48Z","updated_at":"2014-05-07T22:12:48Z","name":"sage_gateway_10","slug":"sage-gateway-10","title":"SageGateway10","links":[{"rel":"self","href":"https://api-staging.value.io/v1/gateways/'.$identifier.'"},{"rel":"index","href":"https://api-staging.value.io/v1/gateways"}]}},"account":{"slug":"splikit"},"token":{"uuid":"05bfd758-5e1a-4ceb-bb39-f64b60d99d30","roles":["admin"]} }';
				$http_code = "200";
            } else if ($destination['type'] == 'mercury') {
                $id = rand(1000000000, 9999999999);
                $mercury_merchant_id = $config['merchant_id'];
                $mercury_password = $config['password'];
                $json_result = ' {"path":"/destinations","route":"/destinations","mode":"post","status":"200 OK","errors": {  },"data": {"destination": {"id":"'.$id.'","account_id":"'.$id.'","config": {"password":"'.$mercury_password.'","merchant_id":"'.$mercury_merchant_id.'"},"_type":"Gateway::Mercury","identifier":"'.$identifier.'","created_at":"2014-06-17T21:45:58Z","payment_address_defaults_to_account": true,"payments_include_address": true,"updated_at":"2014-06-17T21:45:58Z","title":"Mercury Gateway 10","name":"mercury_gateway_10","slug":"mercury-gateway-10","links": [{"rel":"self","href":"https://api-staging.value.io/v1/gateways/'.$identifier.'"},{"rel":"index","href":"https://api-staging.value.io/v1/gateways"}]}},"account":{"slug":"splikit"},"token":{"uuid":"05bfd758-5e1a-4ceb-bb39-f64b60d99d30","roles":["admin"]}}';
                $http_code = "200";
            } else if ($destination['type'] == 'heartland') {
                $id = rand(1000000000, 9999999999);
                $secretApiKey = $config['secretApiKey'];
                $json_result = ' {"path":"/destinations","route":"/destinations","mode":"post","status":"200 OK","errors": {  },"data": {"destination": {"id":"'.$id.'","account_id":"'.$id.'","config": {"secretApiKey":"'.$secretApiKey.'"},"_type":"Gateway::Heartland","identifier":"'.$identifier.'","created_at":"2014-06-17T21:45:58Z","payment_address_defaults_to_account": true,"payments_include_address": true,"updated_at":"2014-06-17T21:45:58Z","title":"Heartland Gateway 10","name":"heartland_gateway_10","slug":"heartand-gateway-10","links": [{"rel":"self","href":"https://api-staging.value.io/v1/gateways/'.$identifier.'"},{"rel":"index","href":"https://api-staging.value.io/v1/gateways"}]}},"account":{"slug":"splikit"},"token":{"uuid":"05bfd758-5e1a-4ceb-bb39-f64b60d99d30","roles":["admin"]}}';
                $http_code = "200";
            } else if ($destination['type'] == 'vio-instant') {
                $id = rand(1000000000, 9999999999);
                $account_number = $data['account_number'];
                $json_result = '{"path":"/destinations","route":"/destinations","mode":"post","status":"200 OK","errors":  {},"data": {"destination": {"id":"'.$id.'","account_id":"'.$id.'","config": {"account_num": '.$account_number.'},"payments_include_address": true,"_type":"Gateway::VIOInstant","identifier":"'.$identifier.'","payment_address_defaults_to_account": true,"name":"Vio Instant Gateway 19","slug":"vio-instant-gateway-19","updated_at":"2019-09-20T14:31:33Z","created_at":"2019-09-20T14:31:33Z","links": [{"rel":"self","href":"https://api-staging.value.io/v1/gateways/61ahbbptkq12"},{"rel":"index","href":"https://api-staging.value.io/v1/gateways"}]}}}';
                $http_code = "200";
            } else {
				throw new Exception("Mock object not set up to create destination for: ".$destination['type']);
			}
		} else if (substr_count($url, "/vioinstant")) {
            $routing_number = $data["bank_account_routing_number"];
            if ($routing_number == "555555555") {
                // failure without an account number
                $json_result = '{"path":"/vioinstant","route":"/vioinstant","mode":"post","status":"422 Unprocessable Entity","errors": {"account":"An error has occurred and the details of this request have been sent to support."},"data": {"account_number": 0,"beneficial_owner_data_result": [],"password": null,"processor_status":"46"}}';
                $http_code = "422";
            } else {
                $account_number = rand(1000000000, 9999999999);
                $password = generateAlphaCode(10);
                $status = '00';
                $http_code = "200";
                if ($routing_number == "888888888") {
                    $status = '88';
                    $http_code = "422";
                }
                $json_result = '{"path":"/vioinstant","route":"/vioinstant","mode":"post","status":"'.$http_code.'","errors": {},"data": {"account_number": '.$account_number.',"beneficial_owner_data_result": [],"password":"'.$password.'","processor_status":"'.$status.'"}}';
            }

        }

		$response['raw_result'] = $json_result;
		$response['error'] = $error;
		$response['error_no'] = $error_no;
		$response['curl_info'] = $curl_info;
		$response['http_code'] = $http_code;
		return $response;
	}
	
	static function curlItNoMock($url,$data,$username_password)
	{
		$service_name = 'VioPayment';
		if ($ch = curl_init($url))
		{		
			curl_setopt($ch, CURLOPT_URL, $url);
			curl_setopt($ch, CURLOPT_USERPWD, "$username_password");
			if ($data)
			{
				$json_data = json_encode($data);
				curl_setopt($ch, CURLOPT_POSTFIELDS, $json_data);
				if ($data['payment']['kind'] == 'void') {
					curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "PUT");
				} else {                                                                  
					curl_setopt($ch, CURLOPT_POST, 1);
				}
				curl_setopt($ch, CURLOPT_HTTPHEADER, array(                                                                          
				    'Content-Type: application/json',                                                                                
				    'Content-Length: ' . strlen($json_data))                                                                       
				);
			}
			$response = parent::curlIt($ch);
			curl_close($curl);
		} else {
			$response['error'] = "FAILURE. Could not connect to ".$service_name;
			myerror_log("ERROR!  could not connect to ".$service_name);
		}
		return $response;
	}
	
}
?>